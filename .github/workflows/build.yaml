name: Build and Deploy

on:
  push:
    branches-ignore: []  # Запускаем для всех веток

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/phonebook
      TAG: ${{ github.sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew build

      - name: Run tests
        run: ./gradlew test

      - name: Login to Docker Hub
        if: github.ref == 'refs/heads/main'  # Логинимся только для main
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ github.ref == 'refs/heads/main' && 'latest' || 'dev' }}
            ${{ env.DOCKER_IMAGE }}:${{ env.TAG }}

      - name: Update kustomization with new image (main only)
        if: github.ref == 'refs/heads/main'
        run: |
          # Устанавливаем kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          chmod +x kustomize
          
          # Обновляем kustomization.yaml
          cd infra/kubernetes
          ../kustomize edit set image phonebook=${{ env.DOCKER_IMAGE }}:${{ env.TAG }}
          
          # Коммитим изменения
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add kustomization.yaml
          git commit -m "Update image to ${{ env.TAG }}" || echo "No changes to commit"
          git push