<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${contact.id != null} ? 'Редактирование контакта' : 'Новый контакт'">
    Контакт</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        rel="stylesheet">
  <link th:href="@{/css/style.css}" rel="stylesheet">

  <style>
    .phone-container {
      margin-bottom: 10px;
    }

    .btn-remove-phone {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }

    .required-field::after {
      content: "*";
      color: red;
      margin-left: 3px;
    }
  </style>
</head>
<body>

<!-- Навигация -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" th:href="@{/}">
      <i class="fas fa-phone-alt me-2"></i>Телефонный справочник
    </a>
    <div class="navbar-nav ms-auto">
      <a th:href="@{/contacts}" class="btn btn-outline-light btn-sm me-2">
        <i class="fas fa-address-book"></i> Контакты
      </a>
      <a th:href="@{/departments}" class="btn btn-outline-light btn-sm me-2" sec:authorize="hasRole('ADMIN')">
        <i class="fas fa-building"></i> Департаменты
      </a>
      <a th:href="@{/users}" class="btn btn-outline-light btn-sm me-2"
         sec:authorize="hasRole('ADMIN')">
        <i class="fas fa-users-cog"></i> Пользователи
      </a>
      <span class="navbar-text me-3" sec:authorize="isAuthenticated()">
        Вы вошли как: <span sec:authentication="name"></span>
      </span>
      <form th:action="@{/logout}" method="post" sec:authorize="isAuthenticated()">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button class="btn btn-outline-light btn-sm" type="submit">Выйти</button>
      </form>
      <a th:href="@{/login}" class="btn btn-outline-light btn-sm"
         sec:authorize="!isAuthenticated()">Войти</a>
    </div>
  </div>
</nav>

<!-- Основной контент -->
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-10">

      <!-- Заголовок -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
          <i class="me-2"
             th:classappend="${contact.id != null} ? 'fas fa-edit' : 'fas fa-plus-circle'"></i>
          <span
              th:text="${contact.id != null} ? 'Редактирование контакта' : 'Новый контакт'"></span>
        </h2>
        <a th:href="@{/contacts}" class="btn btn-secondary">
          <i class="fas fa-arrow-left me-2"></i>Назад
        </a>
      </div>

      <!-- Форма -->
      <div class="card shadow-sm">
        <div class="card-body">
          <form th:action="@{/contacts/save}" th:object="${contact}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" th:field="*{id}"/>
            <input type="hidden" name="returnSearch" th:value="${returnSearch}"/>
            <input type="hidden" name="returnDept" th:value="${returnDept}"/>
            <input type="hidden" name="returnPage" th:value="${returnPage}"/>

            <!-- ФИО раздельно -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="lastName" class="form-label required-field">Фамилия</label>
                <input type="text" class="form-control" id="lastName" th:field="*{lastName}"
                       placeholder="Иванов"
                       th:classappend="${#fields.hasErrors('lastName')} ? 'is-invalid'">
                <div class="invalid-feedback" th:if="${#fields.hasErrors('lastName')}">
                  <span th:errors="*{lastName}"></span>
                </div>
              </div>

              <div class="col-md-4">
                <label for="firstName" class="form-label required-field">Имя</label>
                <input type="text" class="form-control" id="firstName" th:field="*{firstName}"
                       placeholder="Иван"
                       th:classappend="${#fields.hasErrors('firstName')} ? 'is-invalid'">
                <div class="invalid-feedback" th:if="${#fields.hasErrors('firstName')}">
                  <span th:errors="*{firstName}"></span>
                </div>
              </div>

              <div class="col-md-4">
                <label for="middleName" class="form-label">Отчество</label>
                <input type="text" class="form-control" id="middleName" th:field="*{middleName}"
                       placeholder="Иванович"
                       th:classappend="${#fields.hasErrors('middleName')} ? 'is-invalid'">
                <div class="invalid-feedback" th:if="${#fields.hasErrors('middleName')}">
                  <span th:errors="*{middleName}"></span>
                </div>
              </div>
            </div>

            <!-- Должность и подразделение -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="position" class="form-label required-field">Должность</label>
                <input type="text" class="form-control" id="position" th:field="*{position}"
                       placeholder="Генеральный директор"
                       th:classappend="${#fields.hasErrors('position')} ? 'is-invalid'">
                <div class="invalid-feedback" th:if="${#fields.hasErrors('position')}">
                  <span th:errors="*{position}"></span>
                </div>
              </div>

              <div class="col-md-6">
                <label for="departmentId" class="form-label">Подразделение</label>
                <select class="form-select" id="departmentId" th:field="*{departmentId}">
                  <option value="">-- Выберите подразделение --</option>
                  <option th:each="dept : ${departments}"
                          th:value="${dept.id}"
                          th:text="${dept.name}"
                          th:selected="${dept.id == contact.departmentId}">
                  </option>
                </select>
              </div>
            </div>

            <!-- Телефоны -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Служебные телефоны</label>
                <div id="workPhonesContainer" class="phone-container">
                  <div th:each="phone : ${contact.workPhones}">
                    <div class="input-group mb-2">
                      <input type="text" class="form-control" name="workPhones" th:value="${phone}"
                             placeholder="+7 (XXX) XXX-XX-XX">
                      <button type="button" class="btn btn-outline-danger btn-remove-phone"
                              onclick="removePhone(this)" aria-label="Удалить телефон">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm"
                        onclick="addPhone('workPhones')">
                  <i class="fas fa-plus me-1"></i>Добавить номер
                </button>
              </div>

              <div class="col-md-4">
                <label class="form-label">Служебные мобильные</label>
                <div id="workMobilePhonesContainer" class="phone-container">
                  <div th:each="phone : ${contact.workMobilePhones}">
                    <div class="input-group mb-2">
                      <input type="text" class="form-control" name="workMobilePhones"
                             th:value="${phone}" placeholder="+7 (XXX) XXX-XX-XX">
                      <button type="button" class="btn btn-outline-danger btn-remove-phone"
                              onclick="removePhone(this)" aria-label="Удалить телефон">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm"
                        onclick="addPhone('workMobilePhones')">
                  <i class="fas fa-plus me-1"></i>Добавить номер
                </button>
              </div>

              <div class="col-md-4">
                <label class="form-label">Личные телефоны</label>
                <div id="personalPhonesContainer" class="phone-container">
                  <div th:each="phone : ${contact.personalPhones}">
                    <div class="input-group mb-2">
                      <input type="text" class="form-control" name="personalPhones"
                             th:value="${phone}" placeholder="+7 (XXX) XXX-XX-XX">
                      <button type="button" class="btn btn-outline-danger btn-remove-phone"
                              onclick="removePhone(this)" aria-label="Удалить телефон">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm"
                        onclick="addPhone('personalPhones')">
                  <i class="fas fa-plus me-1"></i>Добавить номер
                </button>
              </div>
            </div>

            <!-- Кнопки -->
            <div class="d-flex justify-content-end gap-2">
              <a th:href="@{/contacts}" class="btn btn-secondary">
                <i class="fas fa-times me-2"></i>Отмена
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>
                <span th:text="${contact.id != null} ? 'Обновить' : 'Сохранить'"></span>
              </button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  function addPhone(fieldName) {
    const container = document.getElementById(fieldName + 'Container');
    const newInputGroup = document.createElement('div');
    newInputGroup.className = 'input-group mb-2';
    newInputGroup.innerHTML = `
      <input type="text" class="form-control" name="${fieldName}" placeholder="+7 (XXX) XXX-XX-XX" required>
      <button type="button" class="btn btn-outline-danger btn-remove-phone"
              onclick="removePhone(this)" aria-label="Удалить телефон">
        <i class="fas fa-times"></i>
      </button>`;
    container.appendChild(newInputGroup);
  }

  function removePhone(button) {
    const inputGroup = button.closest('.input-group');
    inputGroup.remove();
  }

  document.addEventListener('DOMContentLoaded', function () {
    ['workPhones', 'workMobilePhones', 'personalPhones'].forEach(function (fieldName) {
      const container = document.getElementById(fieldName + 'Container');
      if (container.querySelectorAll('.input-group').length === 0) {
        addPhone(fieldName);
      }
    });
  });
</script>
</body>
</html>
