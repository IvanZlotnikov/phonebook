<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${contact.id != null} ? 'Редактирование контакта' : 'Новый контакт'">
    Новый контакт
  </title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- Наш кастомный CSS -->
  <link th:href="@{/css/style.css}" rel="stylesheet">

  <style>
    .phone-container {
      margin-bottom: 10px;
    }

    .btn-remove-phone {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }

    .required-field::after {
      content: "*";
      color: red;
      margin-left: 3px;
    }
  </style>
</head>
<body>
<!-- Навигация -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" th:href="@{/}">
      <i class="fas fa-phone-alt me-2"></i>Телефонный справочник
    </a>

    <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3" sec:authorize="isAuthenticated()">
          Вы вошли как: <span sec:authentication="name"></span>
        </span>
      <form th:action="@{/logout}" method="post" sec:authorize="isAuthenticated()">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button class="btn btn-outline-light btn-sm" type="submit">Выйти</button>
      </form>
      <a th:href="@{/login}" class="btn btn-outline-light btn-sm"
         sec:authorize="!isAuthenticated()">Войти</a>
    </div>
  </div>
</nav>

<!-- Основной контент -->
<div class="container mt-4">
  <!-- Сообщения -->
<!--  <div th:replace="~{fragments/messages :: messages}"></div>-->

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="fas" th:classappend="${contact.id != null} ? 'fa-edit' : 'fa-plus'"></i>
      <span th:text="${contact.id != null} ? 'Редактирование контакта' : 'Новый контакт'"></span>
    </h2>
    <a th:href="@{/contacts}" class="btn btn-secondary">
      <i class="fas fa-arrow-left me-1"></i>Назад
    </a>
  </div>

  <div class="card">
    <div class="card-body">
      <!-- Обновляем action формы для поддержки редактирования -->
      <form th:action="@{/contacts/save}" th:object="${contact}" method="post">
        <!-- CSRF токен -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <input type="hidden" th:field="*{id}"/>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="fullName" class="form-label required-field">ФИО</label>
            <input type="text" class="form-control" id="fullName" th:field="*{fullName}"
                   th:classappend="${#fields.hasErrors('fullName')} ? 'is-invalid'">
            <div class="invalid-feedback" th:if="${#fields.hasErrors('fullName')}">
              <span th:errors="*{fullName}"></span>
            </div>
          </div>

          <div class="col-md-6">
            <label for="position" class="form-label required-field">Должность</label>
            <input type="text" class="form-control" id="position" th:field="*{position}"
                   th:classappend="${#fields.hasErrors('position')} ? 'is-invalid'">
            <div class="invalid-feedback" th:if="${#fields.hasErrors('position')}">
              <span th:errors="*{position}"></span>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="departmentId" class="form-label">Подразделение</label>
            <select class="form-select" id="departmentId" th:field="*{departmentId}">
              <option value="">-- Выберите подразделение --</option>
              <option th:each="dept : ${departments}"
                      th:value="${dept.id}"
                      th:text="${dept.name}"
                      th:selected="${dept.id == contact.departmentId}">
              </option>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label">Служебные телефоны</label>
            <div id="workPhonesContainer" class="phone-container">
              <div th:each="phone, status : ${contact.workPhones}">
                <div class="input-group mb-2">
                  <input type="text" class="form-control"
                         name="workPhones" th:value="${phone}" placeholder="+7 (XXX) XXX-XX-XX">
                  <button type="button" class="btn btn-outline-danger btn-remove-phone"
                          onclick="removePhone(this, 'workPhones')" aria-label="Удалить телефон">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm"
                    onclick="addPhone('workPhones')">
              <i class="fas fa-plus me-1"></i>Добавить номер
            </button>
          </div>

          <div class="col-md-4">
            <label class="form-label">Служебные мобильные</label>
            <div id="workMobilePhonesContainer" class="phone-container">
              <div th:each="phone, status : ${contact.workMobilePhones}">
                <div class="input-group mb-2">
                  <input type="text" class="form-control"
                         name="workMobilePhones" th:value="${phone}"
                         placeholder="+7 (XXX) XXX-XX-XX">
                  <button type="button" class="btn btn-outline-danger btn-remove-phone"
                          onclick="removePhone(this, 'workMobilePhones')" aria-label="Удалить телефон">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm"
                    onclick="addPhone('workMobilePhones')">
              <i class="fas fa-plus me-1"></i>Добавить номер
            </button>
          </div>

          <div class="col-md-4">
            <label class="form-label">Личные телефоны</label>
            <div id="personalPhonesContainer" class="phone-container">
              <div th:each="phone, status : ${contact.personalPhones}">
                <div class="input-group mb-2">
                  <input type="text" class="form-control"
                         name="personalPhones" th:value="${phone}"
                         placeholder="+7 (XXX) XXX-XX-XX">
                  <button type="button" class="btn btn-outline-danger btn-remove-phone"
                          onclick="removePhone(this, 'personalPhones')" aria-label="Удалить телефон">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm"
                    onclick="addPhone('personalPhones')">
              <i class="fas fa-plus me-1"></i>Добавить номер
            </button>
          </div>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>
            <span th:text="${contact.id != null} ? 'Обновить' : 'Сохранить'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Функция для добавления поля телефона
  function addPhone(fieldName) {
    const container = document.getElementById(fieldName + 'Container');
    const newInputGroup = document.createElement('div');
    newInputGroup.className = 'input-group mb-2';
    newInputGroup.innerHTML = `
            <input type="text" class="form-control" name="${fieldName}"
             placeholder="+7 (XXX) XXX-XX-XX" required>
            <button type="button" class="btn btn-outline-danger btn-remove-phone"
                    onclick="removePhone(this)" aria-label="Удалить телефон">
                <i class="fas fa-times"></i>
            </button>
        `;
    container.appendChild(newInputGroup);
  }

  // Функция для удаления поля телефона
  function removePhone(button) {
    const inputGroup = button.closest('.input-group');
    inputGroup.remove();
  }

  // Инициализация при загрузке страницы
  document.addEventListener('DOMContentLoaded', function () {
    // Добавляем по одному полю для каждого типа телефона, если их нет
    ['workPhones', 'workMobilePhones', 'personalPhones'].forEach(function (fieldName) {
      const container = document.getElementById(fieldName + 'Container');
      if (container.querySelectorAll('.input-group').length === 0) {
        addPhone(fieldName);
      }
    });
  });
</script>
</body>
</html>